# 概率

## 随机游走

### 有限图上的随机游走

定义：

1. $p_{uv}$表示当前在$u$，下一步在$v$的概率。
2. $p^{(k)}_{uv}$表示当前在$u$，$k$步后在$v$的概率。
3. $p^{(k)}_{uv}=\sum_{w \in N(u)}{p_{uw}p^{k-1}_{wv}}$
4. 转移矩阵$P$的第$i$行第$j$列元素为$p_{ji}$。
5. k步转移矩阵$P^{k}$第$i$行第$j$列元素为$p^{(k)}_{ji}$。
6. $X^{(0)}$为初始态列向量，$X^{(0)}_u$为初始状态时点在$u$的概率。
7. $X^{(k)}=P^kX^{(0)}$为进行$k$次转移后的状态。

期望问题：计算从一些点（给定概率）出发到达某个终末点$t$的期望步数/消耗。

注：在这个问题中，无论原图如何，都需要将$t$点的出边删去并指向虚空，即$\forall u \in V, p_{tu}=0$。

但特别的，有$p^{(0)}_{tt}=1$

设$P(u)$为从$u$出发，经过无限步后到达$t$的概率。特别的$P(t)=1$。

$$P(u)=\sum_{k=1}^{\infty}{p^{(k)}_{ut}}=\sum_{k=1}^{\infty}{\sum_{v \in N(u)}{p_{uv}p^{(k-1)}_{vt}}}=\sum_{v\in N(u)}{p_{uv}\sum_{k=1}^{\infty}}{p^{(k-1)}_{vt}{}}$$
$$=p_{vt}+\sum_{t \neq v \in N(u)}{p_{uv}P(v)}=\sum_{v \in N(u)}{p_{uv}P(v)}$$

设$E(u)$为从$u$出发，到达$t$的期望转移次数。特别的，$E(t)=0$。

$$E(u)=\sum_{k=1}^{\infty}{kp^{(k)}_{ut}}=\sum_{k=1}^{\infty}{k\sum_{v \in N(u)}{p_{uv}p^{(k-1)}_{vt}}}=\sum_{v \in N(u)}{p_{uv}\sum_{k=1}^{\infty}{kp^{(k-1)}_{vt}}}$$

$$=p_{ut}+\sum_{t \neq v \in N(u)}{p_{uv}\sum_{k=1}^{\infty}{(k+1)p^{(k)}_{vt}}}=p_{ut}+\sum_{t\neq v \in N(u)}{p_{uv}\left(\sum_{k=1}^{\infty}{kp_{vt}}+\sum_{k=1}^{\infty}{p_{vt}}\right)}$$

$$=p_{ut}+\sum_{t \neq v \in N(u)}{p_{uv}(E(v)+P(v))}=\sum_{v \in N(u)}{p_{uv}(P(v)+E(v))}$$

设$F(u)$为从$u$出发，到达$t$的期望消耗。其中第$k$步的消耗为$k$。特别的，$F(t)=0$。

$$F(u)=\sum_{k=1}^{\infty}{\frac{k(k+1)}{2}p^{(k)}_{ut}}=\sum_{k=1}^{\infty}{\frac{k(k+1)}{2}\sum_{v \in N(u)}{p_{uv}p^{(k-1)}_{vt}}}=\sum_{v \in N(u)}{p_{uv}\sum_{k=1}^{\infty}{\frac{k(k+1)}{2}p^{(k-1)}_{vt}}}$$

$$=p_{ut}+\sum_{n \neq v \in N(u)}{p_{uv}\sum_{k=1}^{\infty}{\frac{k(k+1)}{2}p^{(k-1)}_{vt}}}=p_{ut}+\sum_{n \neq v \in N(u)}{p_{uv}\sum_{k=1}^{\infty}{\frac{(k+1)(k+2)}{2}p^{(k)}_{vt}}}$$

$$=p_{ut}+\sum_{n \neq v \in N(u)}{p_{uv}\sum_{k=1}^{\infty}{\left[\frac{k(k+1)}{2}+k+1\right]p^{(k)}_{vt}}}=p_{ut}+\sum_{n \neq v \in N(u)}{p_{uv}\left[\sum_{k=1}^{\infty}{\frac{k(k+1)}{2}p^{(k)}_{vt}}+\sum_{k=1}^{\infty}{kp^{(k)}_{vt}}+\sum_{k=1}^{\infty}{p^{(k)}_{vt}}\right]}$$

$$=p_{ut}+\sum_{n\neq v \in N(u)}{p_{uv}[F(v)+E(v)+P(v)]}=\sum_{v \in N(u)}{p_{uv}[F(v)+E(v)+P(v)]}$$

推广：

设$F_m(u)$表示从$u$出发，到达$t$的期望消耗，其中第$k$步消耗为$k^m$。特别的，$F_m(t)=0$，$F_0(u)=P(u)$，$F_1(u)=E(u)$。

$$F_m(u)=\sum_{v\in N(u)}{p_{uv}\sum_{k=1}^{\infty}{k^m p^{(k-1)}_{vt}}}=p_{ut}+\sum_{t \neq v\in N(u)}{p_{uv}\sum_{k=1}^{\infty}{(k+1)^mp_{vt}}}$$

$$=p_{ut}+\sum_{t \neq v\in N(u)}{p_{uv}\sum_{k=1}^{\infty}{\sum_{i=0}^{m}{\binom {m}{i}k^i}p_{vt}}}=p_{ut}+\sum_{t \neq v\in N(u)}{p_{uv}\sum_{i=0}^{m}{\binom {m}{i}\sum_{k=1}^{\infty}{k^i}p_{vt}}}$$

$$=\sum_{v \in N(u)}{p_{uv}\sum_{i=0}^{m}{\binom{m}{i}F_i(v)}}$$

设$E_P(u)$表示从$u$出发，到达$t$的期望消耗，其中第$k$步消耗为$P(k)=\sum_{i=0}^{\infty}{a_ik^i}$。特别的，$E_P(t)=0$。

$$E_P(u)=\sum_{k=1}^{\infty}{\sum_{i=0}^{\infty}{\sum_{v\in N(u)}a_ik^ip_{uv}p^{(k-1)}_{vt}}}=\sum_{v\in N(u)}{p_{uv}\sum_{k=1}^{\infty}{\sum_{i=0}^{\infty}{a_ik^ip^{(k-1)}_{vt}}}}$$

$$=\sum_{v \in N(u)}{p_{uv}\sum_{i=0}^{\infty}a_i\sum_{k=1}^{\infty}{(k+1)^ip^{(k)}_{vt}}}=\sum_{v \in N(u)}{p_{uv}\sum_{i=0}^{\infty}{a_i\sum_{j=0}^{i}{\binom ij \sum_{k=1}^{\infty}{k^{j}p_{vt}^{k}}}}}$$

$$=\sum_{v \in N(u)}{p_{uv}\sum_{j=0}^{\infty}{F_{j}(v)\sum_{i=j}^{\infty}{a_i\binom ij}}}$$

### 无限图上的随机游走

#### 一维直线上的随机游走

无限制：

从原点出发，每次必须往左/右走一步，则时刻$t$在位置$x$的概率为0当且仅当$x>t$或$2 \nmid (x+t)$，否则为$\frac{1}{2^t}\binom {t}{\frac{t-x}{2}}$。

从原点出发，

有限制：

从原点出发，每次可以选择往左右走，但不允许越过原点。默慈金数（允许不动）/卡塔兰数（必须动）。

#### 二维平面网格上的随机游走

无限制：

从原点出发，每次必须往四个方向$(-1,0),(1,0),(0,-1),(0,1)$等概率走一步：

进行坐标变换$(u,v)=(x+y,x-y)$，则相当于每次必须往$(-1,-1),(-1,1),(1,-1),(1,1)$等概率走一步，发现两维互相独立，于是时刻$t$在位置$(u,v)$的概率为0当且仅当$u>t$或$v>t$或$2 \nmid u$或$2 \nmid v$，否则为$\frac{1}{2^{2t}}\binom{t}{\frac{t-u}{2}}\binom{t}{\frac{t-v}{2}}$。逆变换得$\frac{1}{2^{2t}}\binom{t}{\frac{t-x-y}{2}}\binom{t}{\frac{t-x+y}{2}}$。

有限制：

考虑通过坐标变换转化为两维互相独立的一维随机游走。

#### 更高维的情况

三维空间中，从原点出发，每次必须往八个方向$(-1,0,0),(1,0,0),(0,-1,0),(0,1,0),(0,0,-1),(0,0,1),(-1,-1,-1),(1,1,1)$等概率走一步

进行坐标变换$(u,v,w)=(x+y-z,y+z-x,z+x-y)$

注：有逆变换$(x,y,z)=(\frac{u+w}{2},\frac{u+v}{2},\frac{v+w}{2})$

方向|$(1,1,1)$|$(0,1,0)$|$(1,0,0)$|$(0,0,-1)$|$(0,0,1)$|$(-1,0,0)$|$(0,-1,0)$|$(-1,-1,-1)$
-|-|-|-|-|-|-|-|-
$u$|$1$|$1$|$1$|$1$|$-1$|$-1$|$-1$|$-1$
$v$|$1$|$1$|$-1$|$-1$|$1$|$1$|$-1$|$-1$
$w$|$1$|$-1$|$1$|$-1$|$1$|$-1$|$1$|$-1$

观察到三维互相独立，因此$t$时刻在$(x,y,z)$的概率为$$\frac{1}{2^{3t}}\binom {t}{\frac{t-(x+y-z)}{2}}\binom {t}{\frac{t-(y+z-x)}{2}}\binom {t}{\frac{t-(z+x-y)}{2}}$$

注意无法整除时为$0$。
